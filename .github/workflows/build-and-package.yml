name: æ„å»ºå¹¶æ‰“åŒ… CMS

on:
  workflow_dispatch: {}

jobs:
  build-and-package:
    name: æ„å»ºå¹¶æ‰“åŒ…
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ å®‰è£… Nodeï¼ˆå‰ç«¯ï¼‰
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.8
          cache: npm
          cache-dependency-path: cms_client/package-lock.json

      - name: ğŸ“¦ å®‰è£…ä¾èµ–ï¼ˆå‰ç«¯ï¼‰
        working-directory: cms_client
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        working-directory: cms_client
        run: npm run build

      - name: ğŸ”§ å®‰è£… Nodeï¼ˆåç«¯ï¼‰
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.8
          cache: npm
          cache-dependency-path: cms_server/package-lock.json

      - name: ğŸ“¦ å®‰è£…ä¾èµ–ï¼ˆåç«¯ï¼‰
        working-directory: cms_server
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºåç«¯
        working-directory: cms_server
        run: npm run build

      - name: ğŸ—‚ï¸ å‡†å¤‡ cms ç›®å½•
        run: |
          rm -rf cms
          mkdir -p cms/public

      - name: ğŸ“¥ æ‹·è´å‰ç«¯äº§ç‰©åˆ° cms/publicï¼ˆä¸åŒ…å« dist ç›®å½•æœ¬èº«ï¼‰
        run: |
          # æ‹·è´ dist çš„å†…å®¹åˆ° cms/public
          rsync -a --delete --exclude='.DS_Store' cms_client/dist/ cms/public/

      - name: ğŸ“¥ æ‹·è´åç«¯ distã€template ä¸ package.jsonï¼ˆå¿½ç•¥ htmlï¼‰
        run: |
          # dist æ•´ä½“æ‹·è´åˆ° cms/dist
          rsync -a --delete cms_server/dist/ cms/dist/

          # template æ‹·è´åˆ° cms/templateï¼Œå¹¶å¿½ç•¥ *.html
          rsync -a --delete --exclude='*.html' cms_server/template/ cms/template/

          # æ‹·è´ package.json åˆ° cms æ ¹
          cp cms_server/package.json cms/

      - name: ğŸ“¦ ç”Ÿæˆå‹ç¼©åŒ…ï¼ˆä¸åŒ…å« cms æ–‡ä»¶å¤¹æœ¬èº«ï¼‰
        run: |
          TAR_NAME="cms-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}.tar.gz"
          tar -czf "$TAR_NAME" -C cms .
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV

      - name: â¬†ï¸ ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: cms-package
          path: ${{ env.TAR_NAME }}
          if-no-files-found: error
